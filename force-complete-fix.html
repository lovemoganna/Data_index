<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶å®Œæ•´ä¿®å¤ - 173ä¸ªä¸“ä¸šæŒ‡æ ‡</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px 4px;
            min-width: 120px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        .success-btn { background: #28a745; }
        .success-btn:hover { background: #218838; }
        .steps {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .step {
            margin: 8px 0;
            font-weight: bold;
        }
        .step.done { color: #28a745; text-decoration: line-through; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ å¼ºåˆ¶å®Œæ•´ä¿®å¤ - 173ä¸ªä¸“ä¸šæŒ‡æ ‡</h1>
        <p><strong>é—®é¢˜ï¼š</strong> å‰å°åªæ˜¾ç¤º40æ¡æŒ‡æ ‡ï¼Œä¸æ˜¯æ‰¿è¯ºçš„173æ¡</p>
        <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> å®Œå…¨æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶åŠ è½½å®Œæ•´æ•°æ®é›†</p>

        <div class="steps">
            <div class="step" id="step1">âœ… å·²ä¿®æ”¹åº”ç”¨ä»£ç å¼ºåˆ¶åŠ è½½173ä¸ªæŒ‡æ ‡</div>
            <div class="step" id="step2" style="color: #007bff;">ğŸ”„ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆè¿›è¡Œä¸­ï¼‰</div>
            <div class="step" id="step3">â³ é‡æ–°åŠ è½½åº”ç”¨</div>
            <div class="step" id="step4">â³ éªŒè¯ç»“æœ</div>
        </div>

        <div id="status"></div>

        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0;">
            <button onclick="nuclearOption()" class="danger">ğŸ”¥ æ ¸å¼¹çº§æ¸…é™¤</button>
            <button onclick="checkStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
            <button onclick="openApp()" class="success-btn">ğŸš€ æ‰“å¼€åº”ç”¨</button>
            <button onclick="verifyResult()">âœ… éªŒè¯ç»“æœ</button>
        </div>

        <details>
            <summary style="cursor: pointer; font-weight: bold; margin-top: 20px;">ğŸ“‹ ä¿®å¤è¯¦æƒ…</summary>
            <div style="margin-top: 10px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4>å·²å®Œæˆçš„ä¿®å¤ï¼š</h4>
                <ul>
                    <li>âœ… ä¿®æ”¹äº† <code>constants.ts</code> é»˜è®¤ä½¿ç”¨å®Œæ•´æ¨¡å¼</li>
                    <li>âœ… ä¿®æ”¹äº† <code>App.tsx</code> å¼ºåˆ¶åŠ è½½173ä¸ªæŒ‡æ ‡</li>
                    <li>ğŸ”„ æ­£åœ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜...</li>
                </ul>

                <h4>é¢„æœŸç»“æœï¼š</h4>
                <ul>
                    <li>é¡µé¢æ˜¾ç¤ºï¼š<strong>"åŒ¹é…åˆ° 173 æ¡é£é™©é€»è¾‘èŠ‚ç‚¹"</strong></li>
                    <li>DataModeSwitcherï¼š<strong>"åŒ…å«å…¨éƒ¨173ä¸ªä¸“ä¸šæŒ‡æ ‡ï¼Œè¦†ç›–8å¤§ç»´åº¦42ä¸ªå­ç±»"</strong></li>
                </ul>
            </div>
        </details>

        <script>
            function log(message, type = 'info') {
                const status = document.getElementById('status');
                const div = document.createElement('div');
                div.className = `status ${type}`;
                div.innerHTML = `<span style="font-weight: bold;">${new Date().toLocaleTimeString()}</span> - ${message}`;
                status.appendChild(div);
                console.log(message);
            }

            function updateStep(stepNum, status, text) {
                const step = document.getElementById(`step${stepNum}`);
                step.className = status === 'done' ? 'step done' : 'step';
                step.textContent = text;
            }

            async function nuclearOption() {
                log('ğŸš€ å¯åŠ¨æ ¸å¼¹çº§æ¸…é™¤æ¨¡å¼...', 'warning');

                try {
                    // 1. æ¸…é™¤æ‰€æœ‰localStorage
                    log('æ¸…é™¤ localStorage...');
                    localStorage.clear();
                    log('âœ… localStorage å·²æ¸…ç©º', 'success');

                    // 2. åˆ é™¤IndexedDB
                    if ('indexedDB' in window) {
                        await deleteIndexedDB();
                    }

                    // 3. è®¾ç½®æ­£ç¡®æ¨¡å¼
                    localStorage.setItem('preferred_data_mode', 'full');
                    log('âœ… è®¾ç½® preferred_data_mode = "full"', 'success');

                    updateStep(2, 'done', 'âœ… æµè§ˆå™¨ç¼“å­˜å·²å®Œå…¨æ¸…é™¤');
                    log('ğŸ¯ æ ¸å¼¹çº§æ¸…é™¤å®Œæˆï¼ç°åœ¨å¯ä»¥æ‰“å¼€åº”ç”¨äº†ã€‚', 'success');

                } catch (error) {
                    log('âŒ æ¸…é™¤è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message, 'error');
                }
            }

            async function deleteIndexedDB() {
                return new Promise((resolve, reject) => {
                    const deleteRequest = indexedDB.deleteDatabase('MECERiskOntologyDB');
                    deleteRequest.onsuccess = () => {
                        log('âœ… IndexedDB.MECERiskOntologyDB å·²åˆ é™¤', 'success');
                        resolve();
                    };
                    deleteRequest.onerror = () => {
                        log('âŒ åˆ é™¤IndexedDBå¤±è´¥', 'error');
                        reject();
                    };
                    deleteRequest.onblocked = () => {
                        log('âš ï¸ IndexedDBåˆ é™¤è¢«é˜»å¡ï¼Œè¯·å…³é—­å…¶ä»–æ ‡ç­¾é¡µåé‡è¯•', 'warning');
                        setTimeout(() => resolve(), 2000);
                    };
                });
            }

            async function checkStatus() {
                log('ğŸ” æ£€æŸ¥å½“å‰çŠ¶æ€...', 'info');

                try {
                    const dataMode = localStorage.getItem('preferred_data_mode');
                    const migration = localStorage.getItem('data_migration_completed');
                    const oldData = localStorage.getItem('monitor_ontology_v2');

                    log(`ğŸ“Š preferred_data_mode: ${dataMode || 'null'}`);
                    log(`ğŸ“Š data_migration_completed: ${migration || 'null'}`);
                    log(`ğŸ“Š old_data: ${oldData ? 'å­˜åœ¨' : 'null'}`);

                    // æ£€æŸ¥IndexedDB
                    if ('indexedDB' in window) {
                        const dbExists = await checkIndexedDB();
                        log(`ğŸ“Š IndexedDB: ${dbExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    }

                } catch (error) {
                    log('âŒ æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                }
            }

            async function checkIndexedDB() {
                return new Promise((resolve) => {
                    const request = indexedDB.open('MECERiskOntologyDB');
                    request.onsuccess = () => {
                        const db = request.result;
                        db.close();
                        resolve(true);
                    };
                    request.onerror = () => resolve(false);
                    request.onblocked = () => resolve(true);
                });
            }

            function openApp() {
                updateStep(3, 'done', 'ğŸš€ æ­£åœ¨æ‰“å¼€åº”ç”¨...');
                window.open('index.html', '_blank');
                setTimeout(() => {
                    updateStep(4, '', 'â³ è¯·åœ¨åº”ç”¨ä¸­æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º173æ¡æŒ‡æ ‡');
                }, 3000);
            }

            function verifyResult() {
                log('ğŸ” è¯·åœ¨ä¸»åº”ç”¨ä¸­æ£€æŸ¥ä»¥ä¸‹å†…å®¹:', 'info');
                log('1. é¡µé¢é¡¶éƒ¨æ˜¯å¦æ˜¾ç¤º "åŒ¹é…åˆ° 173 æ¡é£é™©é€»è¾‘èŠ‚ç‚¹"', 'info');
                log('2. DataModeSwitcheræ˜¯å¦æ˜¾ç¤º "åŒ…å«å…¨éƒ¨173ä¸ªä¸“ä¸šæŒ‡æ ‡"', 'info');
                log('3. å¦‚æœä»ç„¶æ˜¯40æ¡ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°è¿è¡Œæ¸…é™¤', 'warning');

                updateStep(4, 'done', 'âœ… è¯·æ‰‹åŠ¨éªŒè¯ç»“æœ');
            }

            // è‡ªåŠ¨æ‰§è¡Œæ£€æŸ¥
            window.addEventListener('load', () => {
                log('ğŸ”§ ä¿®å¤å·¥å…·å·²å°±ç»ª', 'info');
                log('å»ºè®®æ‰§è¡Œé¡ºåº: 1.æ ¸å¼¹çº§æ¸…é™¤ â†’ 2.æ‰“å¼€åº”ç”¨ â†’ 3.éªŒè¯ç»“æœ', 'info');
            });
        </script>
    </div>
</body>
</html>
